# Postavleno_Bot

Postavleno_Bot — телеграм-бот, который сейчас фокусируется на базовой авторизации, регистрации и управлении профилем. Все учётные записи хранятся локально в файлах, пароли шифруются `bcrypt`, а навигация работает через единое карточное сообщение в чате.

## 🚀 Быстрый старт

1. Клонируйте репозиторий и создайте виртуальное окружение (пример для Windows):
   ```powershell
   git clone https://github.com/<your-account>/Postavleno_Bot.git
   cd Postavleno_Bot
   python -m venv .venv
   .venv\Scripts\activate
   python -m pip install -U pip
   ```
2. Установите зависимости и dev-набор одной командой:
   ```powershell
   pip install -e ".[dev]"
   ```
3. Скопируйте пример переменных окружения и укажите токен бота:
   ```powershell
   copy .env.example .env
   ```
   В `.env` достаточно задать `BOT_TOKEN`. По желанию можно переопределить `ACCOUNTS_DIR` и `DELETE_USER_MESSAGES`.
4. Запустите бота:
   ```powershell
   python -m postavleno_bot.main
   ```

> Чтобы пропустить запуск polling (например, во время тестов), установите переменную `POSTAVLENO_BOT_SKIP_POLLING=1`.

## 🧭 Навигация и экраны

В чате всегда отображается одна «карточка» с кнопками. Переходы работают через стек и кнопку «Назад».

| Экран | Описание | Кнопки |
|-------|----------|--------|
| **Главная (гость)** | «Привет! Я Postavleno_Bot 👋…» — приветствие, пояснение чем бот помогает и приглашение начать с входа. | 🔐 Авторизация · 🆕 Регистрация · 🔄 Обновить · ✖️ Выйти |
| **Главная (профиль)** | «Добро пожаловать, <компания>!» + блок «Статус интеграций» с отметками ✅/— и подсказкой открыть профиль. | 👤 Профиль · 🚪 Выйти из профиля · 🗑️ Удалить аккаунт · 🔄 Обновить · ✖️ Выйти |
| **Удаление аккаунта** | Карточка подтверждения «Это действие навсегда удалит ваш аккаунт…» с вопросом «Вы уверены?». | Удалить · Назад · ✖️ Выйти |
| **Требуется авторизация** | Показывается при попытке открыть защищённый раздел без активной сессии. | 🔐 Авторизация · 🆕 Регистрация · ✖️ Выйти |
| **Авторизация** | Пошаговый ввод логина → пароля. Ошибка «Аккаунт не найден» выводится отдельной карточкой с Повторить/✖️ Выйти. | Назад · ✖️ Выйти |
| **Регистрация** | Проверка логина на уникальность и пароль ≥ 6 символов. | Назад · ✖️ Выйти |
| **Профиль** | 👤 Профиль, компания, логин, дата регистрации, почта, статусы API-ключей. | 🔑 Сменить WB API · 🔑 Сменить «Мой Склад» API · ✉️ Сменить почту (скоро) · 🔄 Обновить · ⬅️ Назад · 🚪 Выйти из профиля · ✖️ Выйти |
| **Редактор WB/MS** | Запрос нового ключа и проверка по расширенным регекспам. | Назад · ✖️ Выйти |
| **Почта** | Заглушка с текстом «Скоро здесь появится подтверждение email». | Назад · ✖️ Выйти |
| **Неизвестный ввод** | «Хмм… я не понял запрос 🤔…» — кнопки Повторить (возврат к предыдущему экрану) и ✖️ Выйти. | Повторить · ✖️ Выйти |

Все пользовательские сообщения при вводе логина/пароля/токенов удаляются (если `DELETE_USER_MESSAGES=true`).

## 🗂️ Локальное хранилище

```
data/
  accounts/
    <username>/
      profile.json
  sessions.json
```

`profile.json` содержит:
```json
{
  "display_login": "My.Shop",
  "username": "my.shop",
  "password_hash": "$2b$12$...",
  "created_at": "2025-01-01T12:00:00+00:00",
  "company_name": "My.Shop",
  "email": null,
  "wb_api": null,
  "ms_api": null
}
```

* Пароль хранится как bcrypt-хеш (`bcrypt`).
* WB-токены допускают 32–4096 символов `[A-Za-z0-9._=-]`.
* Токены «Мой Склад» — 16–4096 символов `[A-Za-z0-9._:/+=-]`.

`sessions.json` — плоский словарь с привязкой `chat_id -> username` и отметкой времени `since`. Он хранится только локально, поэтому восстановить авторизованное состояние после переезда возможно **только** при наличии файлов из `data/`.

### 🚪 «Выйти из профиля» против 🗑️ «Удалить аккаунт»

* **✖️ Выйти** — просто закрывает карточку в чате. Сессия остаётся активной, повторное `/start` вернёт на актуальный экран.
* **🚪 Выйти из профиля** — удаляет `chat_id` из `sessions.json`, но файлы аккаунта в `data/accounts/<username>/` остаются. Пользователь увидит гостевое меню и сможет снова войти.
* **🗑️ Удалить аккаунт** — снимает сессию, физически удаляет каталог `data/accounts/<username>/` (вся вложенность, кэш и профиль) и показывает гостевое меню с тостом «Аккаунт удалён. Вы можете создать новый в любое время». Операция необратима.

Удаление недоступно для гостей: карточка подтверждения появляется только у авторизованных пользователей. При повторной регистрации с тем же логином создаётся чистая папка аккаунта.

## 📦 Экспорт остатков

У авторизованного пользователя на главной карточке появляется раздел **«Остатки»** с кнопками:

* **📊 Остатки WB (Общие)** — выгружает полный список остатков из Statistics API Wildberries в один XLSX-файл.
* **🏷️ Остатки WB (По складам)** — группирует позиции по складам и артикулам, отдаёт таблицу «Город | Артикул | Кол-во» без нулевых значений.
* **📘 Остатки МойСклад (Общие)** — формирует агрегированный отчёт по `report/stock/all` из JSON API МойСклад.

Файлы сохраняются локально в `data/accounts/<login>/exports/` и параллельно отправляются в чат отдельным сообщением. Названия включают временную метку (`wb_stocks_all_YYYYMMDD_HHMM.xlsx`, `wb_stocks_by_warehouse_...`, `ms_stocks_all_...`). Время подготовки зависит от объёма данных и может достигать минуты: используется постраничная выгрузка (1000 строк за запрос для МойСклад и итерация по `lastChangeDate` для Wildberries).

Перед запуском экспорта убедитесь, что в профиле добавлены нужные токены:

* WB — токен Statistics API (кнопка «🔑 Сменить WB API» в профиле).
* МойСклад — OAuth-токен (кнопка «🔑 Сменить «Мой Склад» API»).

### Пример колонок

* **WB (общие)**: максимум полей, которые возвращает Statistics API, включая `lastChangeDate`, `warehouseName`, `supplierArticle`, `barcode`, размеры, категории, бренды, цены и количественные показатели.
* **WB (по складам)**: ровно три колонки — `Город`, `Артикул`, `Кол-во` (агрегированное значение > 0).
* **МойСклад**: `Артикул`, `Название`, `Внешний код`, `Штрихкоды` (через запятую), `Группа`, `На складе`, `В резерве`, `В пути`, `Всего`, `Доступно`, `Обновлено`.

## ⚙️ Опциональные зависимости

* `orjson` — если установлен, логи пишутся быстрее. При отсутствии автоматически используется стандартный `json` (функция `json_dumps`).
* `httpx[http2]` — включает HTTP/2, но бот корректно работает и без пакета `h2`.

## 🧪 Проверка

```bash
pytest
ruff check src tests
black --check src tests
mypy src
```

## 🖼️ Скриншоты

В каталоге `docs/screenshots/` зарезервированы места для изображений главных экранов (Home, Auth, Profile). Добавьте их при необходимости для презентаций.
