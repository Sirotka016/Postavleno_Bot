# Postavleno_Bot

## Что умеет бот
- локальная регистрация и авторизация без внешних БД;
- профиль с изменением названия компании, ключа Wildberries и подтверждением e-mail;
- выгрузка остатков WB (агрегированные и по складам) в XLSX прямо из Telegram;
- дружественные карточки навигации, очистка пользовательских сообщений и быстрый выход из профиля.

## Запуск (локально)
1. **Создайте виртуальное окружение и активируйте его.**
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
2. **Установите зависимости.**
   ```bash
   pip install -U pip
   pip install -r requirements.txt
   ```
3. **Скопируйте `.env.example` → `.env` и заполните переменные.**
   Минимально нужен `BOT_TOKEN` (токен Telegram-бота) и SMTP-настройки для отправки кодов подтверждения.
4. **Запустите приложение.**
   ```bash
   python -m postavleno_bot.main
   ```

## Настройка почты
Для подтверждения адресов бот отправляет письма через SMTP.
1. Рекомендуемый вариант — Gmail c *App Password* (паролем приложения) из настроек безопасности.
2. В `.env` укажите:
   ```env
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=NeAniiime@gmail.com
   SMTP_PASSWORD=<app-password>
   SMTP_SENDER=Postavleno_Bot
   ```
3. При успешной настройке пользователи получают письмо с шестизначным кодом и могут подтвердить почту прямо в профиле.

## Переменные окружения
| Переменная | Назначение |
|-----------|------------|
| `BOT_TOKEN` | Telegram-токен бота (обязателен). |
| `ACCOUNTS_DIR` | Каталог для хранения профилей и выгрузок (по умолчанию `data/accounts`). |
| `DELETE_USER_MESSAGES` | Удалять ли пользовательские сообщения после обработки (`true`/`false`). |
| `LOG_LEVEL`, `LOG_JSON`, `LOG_RICH` | Настройки логирования. |
| `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`, `SMTP_SENDER` | SMTP параметры для исходящих писем. |

## Тесты
```bash
pytest
```
При необходимости можно запустить статические проверки: `ruff`, `black --check`, `mypy`.

## Частые проблемы
- **Отсутствуют зависимости.** Убедитесь, что выполнена `pip install -r requirements.txt`.
- **Gmail возвращает 535/534.** Проверьте пароль приложения и разрешения SMTP.
- **WB возвращает 401/403.** Скорее всего, истёк или неверен API-ключ — обновите его в профиле.
- **Письмо с кодом не приходит.** Проверьте папку «Спам» и корректность SMTP-настроек.

## Структура проекта
```
src/postavleno_bot/
  core/        # настройки и логирование
  handlers/    # обработчики Telegram-событий
  integrations/# клиенты внешних API (WB)
  services/    # бизнес-логика, экспорт, верификация почты
  ui/          # клавиатуры и карточки
  utils/       # вспомогательные функции (Excel, SMTP)
```
